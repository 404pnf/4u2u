<?php
// $Id$
/**
 * èœå•å›è°ƒå‡½æ•°.
 */
function userreg_callback_page() {
  //è·å–ä¼ é€’è¿‡æ¥çš„å€?
	$name = $_REQUEST['name'];
	$pass = $_REQUEST['pass'];
	//$pass2 = $_REQUEST['pass2'];
	$mail = $_REQUEST['mail'];
	$source = isset($_REQUEST['source'])?$_REQUEST['source']:'';
	$errors = array();
	/*
	//å¯†ç æ˜¯å¦ä¸€è‡´éªŒè¯?
	if($pass != $pass2){
		$errors[] = t('ç¡®è®¤å¯†ç å¿…é¡»å’Œè¾“å…¥å¯†ç ä¿æŒä¸€è‡?);
	}
	// ç”¨æˆ·åéªŒè¯?
	$error = user_validate_name($name);
	if ($error) {
		$errors[] = $error;
	}
	else if (db_result(db_query("SELECT COUNT(*) FROM {users} WHERE LOWER(name) = LOWER('%s')",  $name)) > 0) {
		$errors[] =  t('The name %name is already taken.', array('%name' => $name));
	}
	else if (drupal_is_denied('user', $form_state['values']['name'])) {
		$errors[] =  t('The name %name has been denied access.', array('%name' => $name));
	}

	// emailåœ°å€éªŒè¯:
	
	$ret = user_validate_mail($mail);
	if ($ret) {
		$errors[] = $ret;
	}
	else if (db_result(db_query("SELECT COUNT(*) FROM {users} WHERE LOWER(mail) = LOWER('%s')",  $mail)) > 0) {
		$errors[] =  t('The e-mail address %email is already registered.', array('%email' =>  $mail));
	}
	else if (drupal_is_denied('mail',  $form_state['values']['mail'])) {
		$errors[] = t('The e-mail address %email has been denied access.', array('%email' =>  $mail));
	}
	//æ·»åŠ ucenterçš„éªŒè¯?
  if(module_exist('ucenter')){
		$name_result = uc_user_checkname($name);
		if ($name_result == -1) {
			$errors[] = t('ç”¨æˆ·åä¸åˆæ³•');
		}
		else if ($name_result == -2) {
			$errors[] = t('åŒ…å«è¦å…è®¸æ³¨å†Œçš„è¯è¯­');
		}
		else if ($name_result == -3) {
			$errors[] = t('ç”¨æˆ·åå·²ç»å­˜åœ?);
		}
		// check the email with ucenter's function
		$email_result = uc_user_checkemail($mail);
		if ($email_result == -4) {
			$errors[] = t('Email æ ¼å¼æœ‰è¯¯');
		}
		else if ($email_result == -5) {
			$errors[] = t('Email ä¸å…è®¸æ³¨å†?);
		}
		else if ($email_result == -6) {
			$errors[] = t('è¯?Email å·²ç»è¢«æ³¨å†?);
		}
	}
	*/
	$form_state = array();
	$form_state['values']['name'] = $name; 
	$form_state['values']['mail'] = $mail; 
	$form_state['values']['pass'] = array(
		'pass1' => $pass,
		'pass2' => $pass,
	);
	$form_state['values']['op'] = t('Create new account');
	//global $user;
  //$user = user_load(array('uid' => 1));

	$ret = drupal_execute('user_register', $form_state);
	$errors = form_get_errors();
	
	if(!empty($errors)){
		$reurn_result = array(
			'status' => FALSE,
			'errors' => strip_tags(implode("\n", $errors)),
		);
		//print drupal_to_js($output);
		drupal_json($reurn_result);
		//drupal_set_message('123123');
		//unset($_SESSION['messages']['error']);
		exit();
	}else{
		//module_load_include('inc', 'user', 'user.pages');
		//return $form_state['user']->uid;
		$reurn_result = array(
			'status' => TRUE,
			'errors' => '',
		);
		$sql = "INSERT INTO {userreg} (uid, source, created) VALUES(%d, '%s', %d)";
		db_query($sql,$form_state['user']->uid,$source,time());
		//print drupal_to_js($output);
		drupal_json($reurn_result);
		exit();
	}
	
}

function userreg_test_page(){
	$output ="";
	drupal_add_js(drupal_get_path('module','userreg').'/userreg.js');
	$output .=  t('æµ‹è¯•ç”¨æˆ·æ³¨å†Œç‰¹åˆ«é€šé“çš„é¡µé?);
	$output .= "<div>åœ¨ä¸‹é¢çš„è¾“å…¥æ¡†ä¸­è¾“å…¥æµ‹è¯•é“¾æ¥æ•°æ®</div>";
	$output .='<div><input id="test-userreg-page-input" type="text" name="userreg-input" size="60" /></div>';
	$output .= '<div><a href="#" id="test-userreg-page-link" >æäº¤æµ‹è¯•</a></div>';
	return $output;
}